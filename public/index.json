[{"content":"Bash prompt for training a ControlNet on Stable Diffusion v3.5\nexport MODEL_DIR=\u0026#34;stabilityai/stable-diffusion-3.5-medium\u0026#34; export OUTPUT_DIR=\u0026#34;sd3-controlnet-out\u0026#34; accelerate launch train_controlnet_sd3.py \\ --pretrained_model_name_or_path=$MODEL_DIR \\ --output_dir=$OUTPUT_DIR \\ --dataset_name=\u0026#34;\u0026#34;fusing/fill50k\u0026#34; \\ --resolution=1024 \\ --learning_rate=1e-5 \\ --max_train_steps=15000 \\ --validation_image \u0026#34;./conditioning_image_1.png\u0026#34; \u0026#34;./conditioning_image_2.png\u0026#34; \\ --validation_prompt \u0026#34;red circle with blue background\u0026#34; \u0026#34;cyan circle with brown floral background\u0026#34; \\ --validation_steps=100 \\ --train_batch_size=1 \\ --gradient_accumulation_steps=4 ","permalink":"http://localhost:1313/posts/sd3.5-controlnet-pitfall/","summary":"\u003cp\u003eBash prompt for training a ControlNet on Stable Diffusion v3.5\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eexport MODEL_DIR\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stabilityai/stable-diffusion-3.5-medium\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eexport OUTPUT_DIR\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sd3-controlnet-out\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eaccelerate launch train_controlnet_sd3.py \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    --pretrained_model_name_or_path\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e$MODEL_DIR \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    --output_dir\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e$OUTPUT_DIR \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    --dataset_name\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003efusing/fill50k\u003cspan style=\"color:#e6db74\"\u003e\u0026#34; \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --resolution=1024 \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --learning_rate=1e-5 \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --max_train_steps=15000 \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --validation_image \u0026#34;\u003c/span\u003e./conditioning_image_1.png\u003cspan style=\"color:#e6db74\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e./conditioning_image_2.png\u003cspan style=\"color:#e6db74\"\u003e\u0026#34; \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --validation_prompt \u0026#34;\u003c/span\u003ered circle with blue background\u003cspan style=\"color:#e6db74\"\u003e\u0026#34; \u0026#34;\u003c/span\u003ecyan circle with brown floral background\u003cspan style=\"color:#e6db74\"\u003e\u0026#34; \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --validation_steps=100 \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --train_batch_size=1 \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    --gradient_accumulation_steps=4\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"SD3.5 ControlNet Pitfall"},{"content":"LoRAs also need to be used with another model:\nfrom diffusers import AutoPipelineForText2Image import torch pipeline = AutoPipelineForText2Image.from_pretrained(\u0026#34;stabilityai/stable-diffusion-xl-base-1.0\u0026#34;, torch_dtype=torch.float16).to(\u0026#34;cuda\u0026#34;) Then use the load_lora_weights() method to load the ostris/super-cereal-sdxl-lora weights and specify the weights filename from the repository:\npipeline.load_lora_weights(\u0026#34;ostris/super-cereal-sdxl-lora\u0026#34;, weight_name=\u0026#34;cereal_box_sdxl_v1.safetensors\u0026#34;) prompt = \u0026#34;bears, pizza bites\u0026#34; image = pipeline(prompt).images[0] image Replace the Model and the Lora weights file and folder in the code.\n","permalink":"http://localhost:1313/posts/loading-lora-weights-in-stable-diffusion-model/","summary":"\u003cp\u003eLoRAs also need to be used with another model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e diffusers \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e AutoPipelineForText2Image\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e torch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epipeline \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e AutoPipelineForText2Image\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stabilityai/stable-diffusion-xl-base-1.0\u0026#34;\u003c/span\u003e, torch_dtype\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003etorch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efloat16)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eto(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cuda\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThen use the load_lora_weights() method to load the ostris/super-cereal-sdxl-lora weights and specify the weights filename from the repository:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epipeline\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eload_lora_weights(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ostris/super-cereal-sdxl-lora\u0026#34;\u003c/span\u003e, weight_name\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cereal_box_sdxl_v1.safetensors\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eprompt \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bears, pizza bites\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eimage \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e pipeline(prompt)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eimages[\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eimage\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eReplace the \u003c!-- raw HTML omitted --\u003eModel\u003c!-- raw HTML omitted --\u003e and the \u003c!-- raw HTML omitted --\u003eLora weights file and folder \u003c!-- raw HTML omitted --\u003ein the code.\u003c/p\u003e","title":"Loading Lora Weights in Stable Diffusion Model"},{"content":"云平台：AutoDL 模型加载工具：Ollama 参考：https://github.com/ollama/ollama/blob/main/docs/linux.md\n下载Ollama 服务器上下载ollama比较慢，因此我使用浏览器先下载到本地电脑上。\nhttps://ollama.com/download/ollama-linux-amd64.tgz复制到浏览器进行下载 下载好以后，使用FileZilla等工具上传到云服务器上，这里我上传到autodl-tmp文件夹下。 打开一个terminal，解压下载的文件包：\ntar -C /usr -xzf ollama-linux-amd64.tgz 启用ollama ollama serve 再打开一个terminal，检查一下ollama是否启用 ollama -v 这里可以看到ollama版本，说明启用成功。 拉取模型 这里以deepseek-r1:32b为例进行拉取\nollama pull deepseek-r1:32b 下载过程中可能有掉速，Ctrl+C掉以后再重新ollama pull可以继续下载。 下载完成以后可以查看一下模型列表：\nollama list 运行模型：\nollama run deepseek-r1:32b 测试了一个很常见的，却有许多模型答错的问题：9.11和9.9比大小 这个模型的链式推理很有人味儿，很有吸引力，这可能就是这个模型受很多人关注和称赞的原因吧\n","permalink":"http://localhost:1313/posts/full-process-of-deploying-deepseek-on-remote-server/","summary":"\u003cp\u003e云平台：AutoDL\n模型加载工具：Ollama\n参考：https://github.com/ollama/ollama/blob/main/docs/linux.md\u003c/p\u003e\n\u003ch2 id=\"下载ollama\"\u003e下载Ollama\u003c/h2\u003e\n\u003cp\u003e服务器上下载ollama比较慢，因此我使用浏览器先下载到本地电脑上。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://ollama.com/download/ollama-linux-amd64.tgz\"\u003ehttps://ollama.com/download/ollama-linux-amd64.tgz\u003c/a\u003e复制到浏览器进行下载\n下载好以后，使用FileZilla等工具上传到云服务器上，这里我上传到autodl-tmp文件夹下。\n打开一个terminal，解压下载的文件包：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etar -C /usr -xzf ollama-linux-amd64.tgz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"启用ollama\"\u003e启用ollama\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eollama serve\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"再打开一个terminal检查一下ollama是否启用\"\u003e再打开一个terminal，检查一下ollama是否启用\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eollama -v\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这里可以看到ollama版本，说明启用成功。\n\u003cimg alt=\"版本查看\" loading=\"lazy\" src=\"/posts/full-process-of-deploying-deepseek-on-remote-server/image.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"拉取模型\"\u003e拉取模型\u003c/h2\u003e\n\u003cp\u003e这里以deepseek-r1:32b为例进行拉取\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eollama pull deepseek-r1:32b\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"拉取模型\" loading=\"lazy\" src=\"/posts/full-process-of-deploying-deepseek-on-remote-server/image-1.png\"\u003e\n\u003c!-- raw HTML omitted --\u003e下载过程中可能有掉速，Ctrl+C掉以后再重新ollama pull可以继续下载。\u003c!-- raw HTML omitted --\u003e\n下载完成以后可以查看一下模型列表：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eollama list\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"模型列表\" loading=\"lazy\" src=\"/posts/full-process-of-deploying-deepseek-on-remote-server/image-3.png\"\u003e\u003c/p\u003e\n\u003cp\u003e运行模型：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eollama run deepseek-r1:32b\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e测试了一个很常见的，却有许多模型答错的问题：9.11和9.9比大小\n\u003cimg alt=\"问题测试\" loading=\"lazy\" src=\"/posts/full-process-of-deploying-deepseek-on-remote-server/image-4.png\"\u003e\n这个模型的链式推理很有人味儿，很有吸引力，这可能就是这个模型受很多人关注和称赞的原因吧\u003c/p\u003e","title":"Full process of deploying deepseek on remote server"}]